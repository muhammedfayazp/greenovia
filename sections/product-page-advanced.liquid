{% comment %}
  Advanced Product Page - Dynamic Variants & Image Switching
{% endcomment %}

<script type="application/ld+json">
  {{ product | structured_data }}
</script>

{% liquid
  assign current_variant = product.selected_or_first_available_variant
  assign product_form_id = 'product-form-' | append: section.id
%}

<div class="product-page" data-section-id="{{ section.id }}">
  <div class="container page-width">
    <div class="product-layout">
      
      {%- comment -%} Product Images Gallery {%- endcomment -%}
      <div class="product-media">
        <div class="product-media__main">
            <div class="product-media__featured">
              <img
                src="{{ current_variant.featured_media | default: product.featured_media | image_url: width: 800 }}"
                alt="{{ product.title | escape }}"
                width="800"
                height="800"
                loading="eager"
                class="product-media__image"
                id="MainProductImage"
              >
            </div>
        </div>

        {% if product.media.size > 1 %}
          <div class="product-media__thumbnails">
            {% for media in product.media %}
              <button
                type="button"
                class="product-media__thumbnail {% if media.id == current_variant.featured_media.id or forloop.first %}active{% endif %}"
                data-media-id="{{ media.id }}"
                data-image-src="{{ media | image_url: width: 800 }}"
                aria-label="Load image {{ forloop.index }}"
              >
                <img
                  src="{{ media | image_url: width: 120 }}"
                  alt="{{ media.alt | escape }}"
                  width="120"
                  height="120"
                  loading="lazy"
                >
              </button>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      {%- comment -%} Product Information {%- endcomment -%}
      <div class="product-info">
        
        {%- comment -%} Payment Icons {%- endcomment -%}
        <div class="payment-icons-row">
          <svg viewBox="0 0 38 24" class="payment-icon"><path fill="#fff" d="M35 0H3C1.3 0 0 1.3 0 3v18c0 1.7 1.4 3 3 3h32c1.7 0 3-1.3 3-3V3c0-1.7-1.4-3-3-3z"/><path fill="#00579f" d="M13.6 14.3l-1.6-7.8h-2.6L7.2 14.3h2.6l.5-2h3.2l.3 2h2.4zM10.1 10.4L10.8 7l.9 3.4h-1.6zM20.8 14.3l1.1-6.2c.1-.4 0-.6-.2-.7-.4-.2-1.3-.4-2.5-.4-2.5 0-4.3 1.3-4.3 3.1 0 1.4 1.2 2.3 2.2 2.8.9.5 1.2.8 1.2 1.2 0 .4-.5.6-1.6.6-1.5 0-2.3-.2-3.6-.8l-.5 2.3c.7.3 1.9.6 3.2.6 3.1 0 5-1.5 5-3.8 0-1.3-.8-2.3-2-2.9-.8-.4-1.3-.7-1.3-1.1 0-.4.5-.8 1.5-.8 1 0 1.7.2 2.2.4l-.3 1.7h2.2zM28.4 14.3h2.4l-1.5-7.8h-2.1c-.8 0-1.4.3-1.6.9l-5.7 13.5h2.7l.8-2.3h3.4l.3 2.3h2.5c0-.1.5-2.9.8-6.6zm-3.6-1.2l1.6-4.5.9 4.5H24.8zM35.6 6.5H33c-.1 0-2.8.1-4.8 5.6l-2-6.6h-2.4l3.3 9.7L24.5 21h2.5l7.6-14.5h1z"/></svg>
          <svg viewBox="0 0 38 24" class="payment-icon"><path fill="#fff" d="M35 0H3C1.3 0 0 1.3 0 3v18c0 1.7 1.4 3 3 3h32c1.7 0 3-1.3 3-3V3c0-1.7-1.4-3-3-3z"/><circle cx="13" cy="12" r="7" fill="#eb001b"/><circle cx="25" cy="12" r="7" fill="#f79e1b"/><path fill="#ff5f00" d="M19 17.4c-2.1 0-4-.9-5.4-2.3 1.3-1.6 2.1-3.6 2.1-5.9s-.8-4.2-2.1-5.9c1.3-1.4 3.3-2.3 5.3-2.3 2.1 0 4 .9 5.4 2.3-1.4 1.6-2.1 3.7-2.1 5.9s.7 4.3 2.1 5.9c-1.4 1.4-3.3 2.3-5.3 2.3z"/></svg>
          <svg viewBox="0 0 38 24" class="payment-icon"><path fill="#fff" d="M35 0H3C1.3 0 0 1.3 0 3v18c0 1.7 1.4 3 3 3h32c1.7 0 3-1.3 3-3V3c0-1.7-1.4-3-3-3z"/><path fill="#0079c1" d="M28.3 14h-2.6c0 .4.1.8.3 1.1.2.3.6.5 1.1.5 1.1 0 1.7-.8 1.9-1.3l2.3.4c-.4 1.6-1.8 2.8-4.1 2.8-2.7 0-4.6-1.9-4.6-4.5s1.9-4.5 4.7-4.5c2.6 0 4.3 1.8 4.3 4.3v1.2h-3.3zm.8-1.7c0-1.4-.7-2.2-1.9-2.2-1.1 0-1.9.9-1.9 2.2h3.8zM15.4 10.9h1.3l-2.4 11.2h-3L8.7 12l-1.3-1.1H5v-1h3.7l2.8 9 2.3-9h3l-1.4 1zm-1.4-6.4c0-.9.7-1.6 1.6-1.6s1.6.7 1.6 1.6-.7 1.6-1.6 1.6-1.6-.7-1.6-1.6z"/></svg>
        </div>

        <div class="product-info__header">
          <h1 class="product-title">{{ product.title }}</h1>
        </div>

        <div class="product-price" id="ProductPrice">
          <span class="price-current">
            {{ current_variant.price | money }}
          </span>
          {% if current_variant.compare_at_price > current_variant.price %}
            <span class="price-compare">
              {{ current_variant.compare_at_price | money }}
            </span>
          {% endif %}
        </div>

        {%- comment -%} Product Form {%- endcomment -%}
        {% form 'product', product, id: product_form_id, class: 'product-form' %}
          <input type="hidden" name="id" value="{{ current_variant.id }}">
          
          {%- comment -%} Dynamic Variants Loop {%- endcomment -%}
          {% unless product.has_only_default_variant %}
            <div class="product-variants">
              {% for option in product.options_with_values %}
                <div class="product-option">
                  <label class="product-option__label">
                    {{ option.name }}
                  </label>
                  
                  <div class="option-values">
                    {% for value in option.values %}
                      {%- liquid
                         assign option_disabled = true
                         for variant in product.variants
                           if variant.available and variant.options[forloop.parentloop.index0] == value
                             assign option_disabled = false
                           endif
                         endfor
                      -%}
                      <label class="option-value-card {% if current_variant.options[forloop.parentloop.index0] == value %}checked{% endif %} {% if option_disabled %}sold-out{% endif %}">
                        <input
                          type="radio"
                          name="option-{{ option.name | handleize }}"
                          value="{{ value | escape }}"
                          data-index="option{{ forloop.parentloop.index }}"
                          {% if current_variant.options[forloop.parentloop.index0] == value %}checked{% endif %}
                          class="option-input hidden"
                        >
                        <span class="option-text">{{ value }}</span>
                      </label>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endunless %}
          
          <div class="actions-row">
             {%- comment -%} Quantity {%- endcomment -%}
            <div class="quantity-selector">
                <button type="button" class="qty-btn" onclick="updateQty(-1)">âˆ’</button>
                <input type="number" name="quantity" value="1" min="1" class="qty-input">
                <button type="button" class="qty-btn" onclick="updateQty(1)">+</button>
            </div>

            {%- comment -%} Actions {%- endcomment -%}
            <div class="action-buttons">
                <button
                type="submit"
                name="add"
                id="AddToCart"
                class="btn btn-add-to-cart"
                {% unless current_variant.available %}disabled{% endunless %}
                >
                {% if current_variant.available %}Add to Cart{% else %}Sold Out{% endif %}
                </button>
            </div>
          </div>

        {% endform %}
        
        {%- comment -%} Description & Trust {%- endcomment -%}
        <div class="product-description-container">
          <div class="rte">
            {{ product.description }}
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script id="product-variants-json" type="application/json">
  {{ product.variants | json }}
</script>

<style>
/* Modern Product Page Styles */
.product-layout {
  display: grid;
  grid-template-columns: 1.5fr 1fr;
  gap: 4rem;
  padding: 4rem 0;
  max-width: 1400px;
  margin: 0 auto;
}

/* Icons */
.payment-icons-row {
  display: flex;
  gap: 8px;
  margin-bottom: 1.5rem;
}
.payment-icon {
  width: 38px;
  height: 24px;
}

/* Media */
.product-media__main {
  margin-bottom: 1rem;
}
.product-media__featured {
  border-radius: 0;
  overflow: hidden;
}
.product-media__image {
  width: 100%;
  height: auto;
  display: block;
}
.product-media__thumbnails {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
}
.product-media__thumbnail {
  border: 1px solid transparent;
  cursor: pointer;
  padding: 0;
}
.product-media__thumbnail.active {
  border-color: #333;
}
.product-media__thumbnail img {
  width: 100%;
}

/* Info */
.product-title {
  font-family: var(--font-heading-family); 
  font-size: 2.8rem;
  font-weight: 400; /* Lighter weight like reference */
  color: #111;
  margin: 0 0 0.5rem;
  line-height: 1.2;
}
.price-current {
  font-size: 1.2rem;
  font-weight: 500;
  color: #333;
}
.product-price {
    margin-bottom: 2rem;
}

/* Options */
.product-option {
  margin-bottom: 2rem;
}
.product-option__label {
  display: block;
  font-size: 1rem;
  font-weight: 400;
  margin-bottom: 0.8rem;
  color: #555;
}
.option-values {
  display: flex;
  flex-wrap: wrap;
  width: 100%;
}
.option-value-card {
  border: 1px solid #000;
  padding: 12px 20px;
  cursor: pointer;
  background: #fff;
  transition: all 0.2s;
  flex: 1; /* Stretch to fill */
  text-align: center;
  position: relative;
  min-width: 100px;
  margin-right: -1px; /* Overlap borders */
}
.option-value-card:first-child {
    border-radius: 4px 0 0 4px; /* Optional rounding if desired, or square */
}
.option-value-card:last-child {
    border-radius: 0 4px 4px 0;
}
/* Revert overlap for independent boxes style if preferred, referencing image they look like separate boxes */
.option-value-card {
    margin-right: 10px;
    border-radius: 0;
    margin-bottom: 10px;
    flex: 0 0 auto;
    min-width: 120px;
}

.option-value-card.checked {
  border: 2px solid #000;
  padding: 11px 19px; /* adjust for border width */
}

/* Diagonal Line for Sold Out */
.option-value-card.sold-out {
    color: #999;
    border-color: #ddd;
    background: linear-gradient(to top right, transparent 48%, #999 49%, #999 51%, transparent 52%);
}

/* Actions Row */
.actions-row {
    display: flex;
    gap: 16px;
    align-items: center;
    margin-top: 3rem;
}

/* Qty & Actions Pill Style */
.quantity-selector {
  display: inline-flex;
  border: 1px solid #ccc;
  border-radius: 100px;
  padding: 5px 10px;
  align-items: center;
  height: 54px;
}
.qty-btn {
  background: transparent;
  border: none;
  width: 30px;
  cursor: pointer;
  font-size: 1.2rem;
  color: #555;
}
.qty-input {
  width: 40px;
  border: none;
  text-align: center;
  font-weight: 400;
  font-size: 1rem;
  color: #000;
}

.action-buttons {
    flex: 1;
}

.btn-add-to-cart {
  width: 100%;
  background-color: #8B9D8B; /* Sage Green from image */
  color: white;
  border: none;
  height: 54px;
  border-radius: 100px;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
  letter-spacing: 0.5px;
}
.btn-add-to-cart:hover {
  background-color: #7A8C7A;
}
.btn-add-to-cart:disabled {
  background-color: #8B9D8B;
  opacity: 0.8;
  cursor: not-allowed;
}

/* Hidden Utils */
.hidden {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}

@media(max-width: 990px) {
  .product-layout {
    grid-template-columns: 1fr;
    padding: 2rem 1rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const variants = JSON.parse(document.getElementById('product-variants-json').textContent);
  const options = document.querySelectorAll('.option-input');
  const planterInputs = document.querySelectorAll('.planter-input');
  const mainImage = document.getElementById('MainProductImage');
  const thumbBtns = document.querySelectorAll('.product-media__thumbnail');

  // Helper: Format Money
  function formatMoney(cents) {
    return 'AED ' + (cents / 100).toFixed(2);
  }

  // Handle Option Change
  function handleOptionChange() {
    // 1. Get selected values
    const selectedValues = [];
    document.querySelectorAll('.product-option').forEach(opt => {
      const checked = opt.querySelector('.option-input:checked');
      if(checked) selectedValues.push(checked.value);
    });

    // 2. Find variant
    const matchedVariant = variants.find(v => {
      return v.options.every((val, index) => val === selectedValues[index]);
    });

    // 3. Update UI
    if (matchedVariant) {
      // Update ID
      document.querySelector('input[name="id"]').value = matchedVariant.id;
      
      // Update Price Display
      document.querySelector('.price-current').textContent = formatMoney(matchedVariant.price);
      
      // Update Button
      const btn = document.getElementById('AddToCart');
      if (matchedVariant.available) {
        btn.textContent = 'Add to Cart';
        btn.disabled = false;
      } else {
        btn.textContent = 'Sold Out';
        btn.disabled = true;
      }

      // Update URL (optional)
      const newUrl = new URL(window.location);
      newUrl.searchParams.set('variant', matchedVariant.id);
      window.history.replaceState({}, '', newUrl);

      // Update Image if variant has one
      if (matchedVariant.featured_media && matchedVariant.featured_media.preview_image) {
         updateMainImage(matchedVariant.featured_media.preview_image.src);
      } else if (matchedVariant.featured_image) {
         updateMainImage(matchedVariant.featured_image.src);
      }
    }

    // Refresh styling
    options.forEach(opt => {
      opt.parentElement.classList.toggle('checked', opt.checked);
    });
    
    // Update labels
    document.querySelectorAll('.product-option').forEach((block, i) => {
        const checked = block.querySelector('.option-input:checked');
        const labelSpan = block.querySelector('.product-option__selected');
        if(checked && labelSpan) labelSpan.textContent = '- ' + checked.value;
    });

    updateTotal();
  }

  // Handle Planter Change
  function handlePlanterChange() {
    planterInputs.forEach(input => {
      input.nextElementSibling.classList.toggle('checked', input.checked);
    });
    const checked = document.querySelector('.planter-input:checked');
    const labelSpan = document.getElementById('SelectedPlanter');
    if(checked && labelSpan) {
       const title = checked.dataset.planterTitle || 'None';
       labelSpan.textContent = '- ' + title;
    }
    updateTotal();
  }

  // Update Total
  function updateTotal() {
    const currentPriceText = document.querySelector('.price-current').textContent;
    const basePrice = parseFloat(currentPriceText.replace(/[^0-9.]/g, ''));
    
    let planterPrice = 0;
    const selectedPlanter = document.querySelector('.planter-input:checked');
    if (selectedPlanter && selectedPlanter.dataset.planterPrice) {
      planterPrice = parseFloat(selectedPlanter.dataset.planterPrice) / 100;
    }

    const qty = parseInt(document.querySelector('.qty-input').value) || 1;
    const total = (basePrice + planterPrice) * qty;
    
    const totalEl = document.getElementById('TotalPrice');
    if(totalEl) {
      totalEl.textContent = 'AED ' + total.toFixed(2);
    }
  }

  // Update Main Image
  function updateMainImage(src) {
    if(!src) return;
    let newSrc = src;
    if(src.indexOf('?') === -1) newSrc += '?width=800';
    
    mainImage.src = newSrc;
    
    // Highlight thumbnail based on URL matching
    thumbBtns.forEach(btn => {
        const thumbSrc = btn.dataset.imageSrc;
        // Check if the current main image src contains the media ID or base path
        if(thumbSrc && newSrc.split('?')[0] === thumbSrc.split('?')[0]) {
             btn.classList.add('active');
        } else {
             btn.classList.remove('active');
        }
    });
  }

  // Thumbnail Click
  thumbBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      thumbBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      const src = this.dataset.imageSrc;
      if(src) mainImage.src = src;
    });
  });

  // Quantity Global Hook
  window.updateQty = function(change) {
    const input = document.querySelector('.qty-input');
    let val = parseInt(input.value) || 1;
    val = Math.max(1, val + change);
    input.value = val;
    updateTotal();
  };

  // Listeners
  options.forEach(opt => opt.addEventListener('change', handleOptionChange));
  planterInputs.forEach(opt => opt.addEventListener('change', handlePlanterChange));
});
</script>

{% schema %}
{
  "name": "Product Page Advanced",
  "settings": [
    {
      "type": "text",
      "id": "planter_products",
      "label": "Planter Product Handles",
      "default": "ceramic-planter-small,ceramic-planter-medium"
    }
  ]
}
{% endschema %}

